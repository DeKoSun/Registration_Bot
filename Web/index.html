<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ФЕНИКС — регистрация игрока</title>

  <!-- PUBLIC ключи Supabase -->
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || "https://ucdvtuifhmxnygibykhl.supabase.co";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjZHZ0dWlmaG14bnlnaWJ5a2hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDc4MDYsImV4cCI6MjA3NTQ4MzgwNn0.G7RdjUdwwOnjnAuWi0FwjqUoWAr4vutqUN7NUMmCIgM";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Ruslan+Display&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#080b10; --panel:#0f141b;
      --gold:#ffd166; --gold-2:#ffe8a3;
      --ink:#f4f6f8; --muted:#9aa5b1;
      --accent:#ff6a00; --accent-2:#ff9f43;
      --radius:20px;
      --shadow:0 10px 30px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
      --ok:#00c853; --info:#2962ff; --err:#d50000;
    }
    html,body{height:100%} *,*::before,*::after{box-sizing:border-box}
    body{
      margin:0; overflow-x:hidden; color:var(--ink);
      background:radial-gradient(65% 55% at 50% 40%, #0f141b, #080b10);
      font:500 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    .bg-video{position:fixed; inset:0; z-index:100; pointer-events:none; display:grid; place-items:center}
    .bg-video video{width:100vw; height:100vh; object-fit:cover}
    .bg-video::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(6,8,12,.55) 0%, rgba(6,8,12,.18) 32%, rgba(6,8,12,.10) 45%, rgba(6,8,12,.35) 70%, rgba(6,8,12,.62) 100%);
    }

    canvas#embers{position:fixed; inset:0; z-index:110; pointer-events:none}

    .solar{
      position:fixed; inset:0; z-index:120; pointer-events:none; filter:blur(6px);
      background:
        radial-gradient(1200px 400px at 50% -200px, rgba(255,140,20,.12), transparent 70%),
        radial-gradient(800px 320px at 20% -120px, rgba(255,200,80,.10), transparent 60%),
        radial-gradient(900px 320px at 80% -120px, rgba(255,120,40,.08), transparent 60%);
    }

    .wrap{max-width:900px; margin:0 auto; padding:24px 20px 44px; position:relative; z-index:130}

    .card{
      position:relative; overflow:hidden; border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(20,25,35,.72), rgba(12,16,22,.88));
      border:1px solid rgba(255,255,255,.06); box-shadow:var(--shadow);
      backdrop-filter:blur(10px) saturate(120%);
      margin-bottom:16px;
    }

    .feathers{position:absolute; inset:-8px; pointer-events:none; filter:drop-shadow(0 0 10px rgba(255,106,0,.35)); opacity:.75; z-index:0}
    .feathers span{position:absolute; color:rgba(255,159,67,.9); font-size:12px; animation:float 12s linear infinite}
    .feathers span:nth-child(odd){color:rgba(255,106,0,.95)}
    @keyframes float{to{transform:translateY(-35px) rotate(360deg)}}

    header.hero{position:relative; z-index:1; padding:26px 26px 14px; text-align:center}
    h1.title{
      font-family:'Ruslan Display',serif; text-transform:uppercase; letter-spacing:.12em; font-weight:400;
      margin:6px 0 8px; font-size:52px;
      background:linear-gradient(180deg,var(--gold-2),var(--gold)); -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 0 16px rgba(255,106,0,.28), 0 0 30px rgba(255,223,144,.2);
      animation:breatheGlow 5.2s ease-in-out infinite;
    }
    @keyframes breatheGlow{
      0%{text-shadow:0 0 14px rgba(255,106,0,.2), 0 0 20px rgba(255,223,144,.12)}
      50%{text-shadow:0 0 28px rgba(255,106,0,.45),0 0 36px rgba(255,223,144,.24)}
      100%{text-shadow:0 0 14px rgba(255,106,0,.2), 0 0 20px rgba(255,223,144,.12)}
    }
    .subtitle{margin:8px 0 0; color:var(--muted); font-size:14px}

    .egg-wrap{display:flex; justify-content:center; align-items:center; margin:6px auto 6px; height:148px}
    .egg{
      position:relative; width:148px; height:148px; border-radius:24px; overflow:hidden;
      background:radial-gradient(circle at 50% 55%, rgba(255,210,120,.15), rgba(255,130,40,.08) 60%, transparent 65%);
      box-shadow:0 0 24px rgba(255,160,60,.22), 0 0 54px rgba(255,120,30,.12), inset 0 0 18px rgba(255,200,120,.07);
    }
    .egg img{width:100%; height:100%; object-fit:cover; display:block; image-rendering:auto; filter:saturate(1.05) contrast(1.02)}
    .egg::after{content:""; position:absolute; inset:-12px; border-radius:28px; filter:blur(18px); pointer-events:none;
      background:conic-gradient(from 0deg, rgba(255,160,60,.12), rgba(255,210,120,.06), transparent 40%, rgba(255,120,40,.10));
      animation:eggGlow 6s ease-in-out infinite}
    @keyframes eggGlow{0%,100%{opacity:.55; transform:scale(1)} 50%{opacity:.85; transform:scale(1.02)}}

    form{position:relative; z-index:1; padding:8px 18px 26px}
    .group{margin:14px 0 12px}
    #birthGroup{margin-bottom:8px}
    .group.grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:4px}

    label{display:block; font-weight:700; color:var(--gold-2); margin:0 0 10px 2px; letter-spacing:.03em; text-shadow:0 0 16px rgba(255,106,0,.25)}
    .group label:not(.chip){font-size:17px; color:var(--gold); margin:18px 0 12px 2px}

    .input, textarea, select{
      width:100%; color:var(--ink);
      background:linear-gradient(180deg, rgba(20,24,32,.85), rgba(12,16,22,.85));
      border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; outline:none; transition:.2s ease;
      box-shadow:inset 0 2px 6px rgba(0,0,0,.35); font-size:15px;
    }
    textarea{min-height:84px; resize:vertical}
    .input::placeholder, textarea::placeholder{color:#a9b4bf}
    .input:focus, textarea:focus, select:focus{border-color:rgba(255,106,0,.45); box-shadow:0 0 0 4px rgba(255,106,0,.12), inset 0 2px 6px rgba(0,0,0,.35)}

    select{appearance:none; -webkit-appearance:none; -moz-appearance:none; padding-right:42px;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23ffe8a3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 14px center;
    }
    select option{color:#0b0f14; background:#fff}
    select option[disabled]{color:#8b8f99}

    .chips{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    .chip{
      position:relative; display:flex; align-items:center; gap:12px; padding:14px; border-radius:14px; width:100%; cursor:pointer;
      background:linear-gradient(180deg, rgba(20,24,32,.65), rgba(15,20,26,.9)); border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow);
    }
    .chip:hover{transform:translateY(-1px); border-color:rgba(255,106,0,.35); box-shadow:0 6px 22px rgba(255,106,0,.18), var(--shadow)}
    .chip input{position:absolute; inset:0; opacity:0; pointer-events:none}

    .toggler{width:22px; height:22px; flex:0 0 22px; border-radius:8px; background:linear-gradient(180deg, rgba(20,24,32,.85), rgba(12,16,22,.85)); border:1px solid rgba(255,255,255,.08); position:relative; box-shadow:inset 0 2px 6px rgba(0,0,0,.35)}
    .toggler::after{content:""; position:absolute; inset:4px; border-radius:6px; background:linear-gradient(180deg, var(--accent-2), var(--accent)); box-shadow:0 0 18px rgba(255,106,0,.45); transform:scale(0); transition:.18s ease}
    .chip input:checked + .toggler::after{transform:scale(1)}

    .icon-img{width:48px; height:48px; flex:0 0 48px; border-radius:12px; background-size:cover; background-position:center; box-shadow:0 2px 6px rgba(0,0,0,.35); outline:1px solid rgba(255,255,255,.08)}
    .label-inline{color:var(--ink)}

    #daysChips{grid-template-columns:repeat(3,minmax(0,1fr))}
    #daysChips .sunday{grid-column:1/-1; justify-content:center}

    .submit{
      width:100%; border:0; cursor:pointer; margin-top:12px; font-weight:900; letter-spacing:.06em; font-size:18px; text-transform:uppercase; color:#0b0f14;
      border-radius:18px; padding:20px 24px; min-height:64px;
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      box-shadow:0 18px 30px rgba(255,106,0,.35), inset 0 -3px 0 rgba(0,0,0,.25);
      transition:transform .12s ease, box-shadow .12s ease;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
    }
    .submit:hover{transform:translateY(-1px); box-shadow:0 26px 40px rgba(255,106,0,.45)}

    /* --- Центрированные кнопки в админке --- */
    .actions {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 200px;        /* одинаковая ширина */
      height: 56px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 900;
      text-transform: uppercase;
      color: #0b0f14;
      background: linear-gradient(90deg,#ff6a00,#ff9f43);
      box-shadow: 0 10px 20px rgba(255,106,0,.25), inset 0 -3px 0 rgba(0,0,0,.25);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 16px 26px rgba(255,106,0,.4); }
    .btn:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(255,106,0,.25); }
    @media (max-width:520px){ .actions{flex-direction:column; gap:12px} .btn{width:100%} }

    @media (max-width:520px){
      .chips{grid-template-columns:1fr}
      h1.title{font-size:42px}
      .egg-wrap{height:136px}
      .egg{width:136px; height:136px}
      #daysChips{grid-template-columns:1fr}
      .group.grid-2{grid-template-columns:1fr}
    }
    @media (prefers-reduced-motion:reduce){
      .bg-video video{animation:none}
    }

    /* ======= Phoenix toasts (центр, без кнопки, 10 сек) ======= */
    #phoenix-toasts{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none; z-index:9999; padding:24px;
    }
    .toast{
      --dur:10000ms;
      width:min(92vw,560px);
      pointer-events:auto;
      color:#fff; border-radius:16px;
      padding:20px 24px;
      box-shadow:0 18px 60px rgba(0,0,0,.35), inset 0 0 24px rgba(255,255,255,.08);
      backdrop-filter: blur(4px);
      position:relative; overflow:hidden;
      font:600 16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial;
      animation:toast-in .35s ease, toast-out .4s ease var(--dur) forwards;
      text-align:center;
    }
    .toast.success{ background: radial-gradient(120% 120% at 0% 0%, #1f4d2c 0%, #0b1a10 55%), linear-gradient(90deg,#00e676,#00c853) }
    .toast.info{    background: radial-gradient(120% 120% at 0% 0%, #0f2a66 0%, #0a1226 55%), linear-gradient(90deg,#448aff,#2962ff) }
    .toast.error{   background: radial-gradient(120% 120% at 0% 0%, #4d1010 0%, #1a0b0b 55%), linear-gradient(90deg,#ff5252,#d50000) }
    .toast::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:3px;
      background:rgba(255,255,255,.55);
      transform-origin:left; transform:scaleX(1);
      animation:bar var(--dur) linear forwards; mix-blend-mode:soft-light;
    }
    @keyframes toast-in{from{transform:translateY(14px) scale(.98);opacity:0} to{transform:translateY(0) scale(1);opacity:1}}
    @keyframes toast-out{to{opacity:0; transform:translateY(10px) scale(.98)}}
    @keyframes bar{to{transform:scaleX(0)}}
    #phoenix-toasts.stack{align-items:flex-start; justify-content:center}
    #phoenix-toasts.stack .toast{margin-top:10px}

    /* ====== Admin dashboard styles ====== */
    .dash-row{display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:12px 14px}
    .filters{display:grid; grid-template-columns:1fr; gap:10px}
    .filter-group{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px}
    .fg-title{
      font-weight:900; color:var(--gold); margin:2px 0 12px 2px;
      font-size:16px; letter-spacing:.05em; text-shadow:0 0 10px rgba(255,106,0,.25);
    }
    .pills{display:flex; flex-wrap:wrap; gap:10px}
    .pill{
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg,rgba(18,22,30,.92),rgba(12,16,22,.96));
      cursor:pointer; font-size:15px; font-weight:700; color:var(--ink);
      text-shadow:0 1px 0 rgba(0,0,0,.6);
    }
    .pill.active{border-color:rgba(255,106,0,.6); box-shadow:0 0 0 4px rgba(255,106,0,.14) inset}
    .dash-metrics{display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:10px}
    .metric{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:10px; text-align:center}
    .metric .k{font-size:22px; font-weight:900; color:var(--gold)}
    .metric .l{font-size:12px; color:#aeb6c2}

    .heat{overflow:auto; border:1px solid rgba(255,255,255,.10); border-radius:14px}
    .heat table{width:100%; border-collapse:collapse}
    .heat th,.heat td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); border-right:1px solid rgba(255,255,255,.06); text-align:center; font-size:14px}
    .heat th{position:sticky; top:0; background:rgba(15,18,26,.95); z-index:1}
    .hcell{border-radius:8px; padding:6px 8px; display:inline-block; min-width:36px}
    .heat-0{background:#1b2230}
    .heat-1{background:#26344a}
    .heat-2{background:#2f4463}
    .heat-3{background:#38547b}
    .heat-4{background:#416594}
    .heat-5{background:#4a75ac}
    .heat-6{background:#5386c5}
    .heat-7{background:#5c96dd}
    .heat-8{background:#65a6f6}
    .heat-9{background:#6eb6ff}
    @media (max-width:900px){ .dash-row{grid-template-columns:1fr} .dash-metrics{grid-template-columns:repeat(2,1fr)} }

    /* --- Аккуратный ряд для тумблера МСК --- */
    .filter-group.toggle-row{
      display:flex;
      align-items:center;      /* идеальное вертикальное выравнивание */
      justify-content:space-between;
      padding:10px 16px;
      margin-top:4px;
    }
    .fg-title.toggle-label{
      margin:0;
      font-size:16px;
      color:var(--gold);
      font-weight:900;
      text-shadow:0 0 10px rgba(255,106,0,.25);
      letter-spacing:.05em;
    }
    .toggle-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:74px;
      height:34px;
      border-radius:999px;
      font-weight:700;
      font-size:15px;
      line-height:1;              /* идеально центрирует текст */
      background:linear-gradient(180deg, rgba(20,24,32,.85), rgba(12,16,22,.9));
      border:1px solid rgba(255,255,255,.12);
      color:var(--ink);
      cursor:pointer;
      transition:all .2s ease;
      box-shadow:0 2px 8px rgba(0,0,0,.3);
      user-select:none;
    }
    .toggle-pill.active{
      border-color:rgba(255,106,0,.6);
      background:linear-gradient(90deg,#ff6a00,#ff9f43);
      color:#0b0f14;
      box-shadow:0 0 10px rgba(255,106,0,.45);
    }
  </style>
</head>
<body>
  <!-- Фон -->
  <div class="bg-video" aria-hidden="true">
    <video id="bgvid" preload="metadata" autoplay playsinline muted loop poster="icons/phoenix-bg.png">
      <source src="icons/phoenix-bg.webm" type="video/webm">
      <source src="icons/phoenix-bg.mp4" type="video/mp4">
      <img src="icons/phoenix-bg.png" alt="">
    </video>
  </div>

  <canvas id="embers"></canvas>
  <div class="solar" aria-hidden="true"></div>

  <div class="wrap">
    <div class="card">
      <div class="feathers" aria-hidden="true"></div>

      <header class="hero">
        <h1 class="title">ФЕНИКС</h1>

        <div class="egg-wrap">
          <div class="egg">
            <img id="egggif" src="icons/egg.gif" alt="Яйцо феникса" loading="eager" decoding="sync">
          </div>
        </div>

        <p class="subtitle">Заполни форму — пусть пламя приведёт тебя в команду</p>
      </header>

      <form id="regForm">
        <div class="group">
          <label for="nickname">Ник в игре Doors & Treasures</label>
          <input class="input" id="nickname" name="nickname" placeholder="например, DeKo_Sun" required maxlength="40" />
        </div>

        <div class="group">
          <label for="telegram">Telegram (без @)</label>
          <input class="input" id="telegram" name="telegram" placeholder="например, DeKo_Soon" required pattern="^[A-Za-z0-9_]{5,}$" />
        </div>

        <div class="group" id="birthGroup">
          <label for="birthdate">Дата рождения</label>
          <input class="input" id="birthdate" name="birthdate" type="date" required />
        </div>

        <div class="group grid-2">
          <div>
            <label for="country">Страна</label>
            <input class="input" id="country" name="country" placeholder="например, США" maxlength="60" autocapitalize="off" autocomplete="country-name" />
          </div>
          <div>
            <label for="city">Город</label>
            <input class="input" id="city" name="city" placeholder="например, Нью-Йорк" maxlength="60" autocapitalize="off" autocomplete="address-level2" />
          </div>
        </div>

        <div class="group">
          <label>Какие дни предпочитаешь для игр?</label>
          <div class="chips" id="daysChips"></div>
        </div>

        <div class="group">
          <label>Удобное время для игр (местное время)</label>
          <div class="chips" id="timesChips"></div>
        </div>

        <div class="group">
          <label>Любимые колоды(а)</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="decks" value="Вампир"><span class="toggler"></span><div class="icon-img" style="background-image:url('icons/Vampire.png')"></div><span class="label-inline">Вампир</span></label>
            <label class="chip"><input type="checkbox" name="decks" value="Ктулху"><span class="toggler"></span><div class="icon-img" style="background-image:url('icons/Cthulhu.png')"></div><span class="label-inline">Ктулху</span></label>
            <label class="chip"><input type="checkbox" name="decks" value="Котэ"><span class="toggler"></span><div class="icon-img" style="background-image:url('icons/Cat.png')"></div><span class="label-inline">Котэ</span></label>
            <label class="chip"><input type="checkbox" name="decks" value="Стандарт"><span class="toggler"></span><div class="icon-img" style="background-image:url('icons/Standard.png')"></div><span class="label-inline">Стандарт</span></label>
            <label class="chip"><input type="checkbox" name="decks" value="Орк"><span class="toggler"></span><div class="icon-img" style="background-image:url('icons/Orc.png')"></div><span class="label-inline">Орк</span></label>
            <label class="chip"><input type="checkbox" name="decks" value="Упряжка"><span class="toggler"></span><div class="icon-img" style="background-image:url('icons/Sled.png')"></div><span class="label-inline">Упряжка</span></label>
            <label class="chip"><input type="checkbox" name="decks" value="Гном"><span class="toggler"></span><div class="icon-img" style="background-image:url('icons/Dwarf.png')"></div><span class="label-inline">Гном</span></label>
            <label class="chip"><input type="checkbox" name="decks" value="Звёздный"><span class="toggler"></span><div class="icon-img" style="background-image:url('icons/alien.png')"></div><span class="label-inline">Звёздный</span></label>
          </div>
        </div>

        <div class="group">
          <label>Какие игровые роли предпочитаешь?</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="roles" value="Атакующий"><span class="toggler"></span><span class="label-inline">⚔️ Атакующий</span></label>
            <label class="chip"><input type="checkbox" name="roles" value="Оборонительный"><span class="toggler"></span><span class="label-inline">🛡️ Оборонительный</span></label>
            <label class="chip"><input type="checkbox" name="roles" value="Комбинированный"><span class="toggler"></span><span class="label-inline">🔀 Комбинированный</span></label>
            <label class="chip"><input type="checkbox" name="roles" value="Капитан пары"><span class="toggler"></span><span class="label-inline">👑 Капитан пары</span></label>
          </div>
        </div>

        <div class="group">
          <label for="experience">Опыт в Doors & Treasures</label>
          <select id="experience" class="input" name="experience" required>
            <option value="" disabled selected hidden>выбери…</option>
            <option value="Новичок (0–100 игр)">Новичок (0–100 игр)</option>
            <option value="Опытный (101–1 000 игр)">Опытный (101–1 000 игр)</option>
            <option value="Ветеран (1 000 и более игр)">Ветеран (1 000 и более игр)</option>
          </select>
        </div>

        <div class="group">
          <label>Клановая вовлечённость</label>
          <label class="chip">
            <input type="checkbox" id="clan_life" />
            <span class="toggler" aria-hidden="true"></span>
            <span class="label-inline">Готов принимать участие в жизни клана</span>
          </label>
          <label class="chip" style="margin-top:8px;">
            <input type="checkbox" id="play_other" />
            <span class="toggler" aria-hidden="true"></span>
            <span class="label-inline">Предпочитаю играть в Alias, Codenames, Бункер и другие игры</span>
          </label>
        </div>

        <div class="group">
          <label for="expect">Ожидания от клана</label>
          <textarea id="expect" name="expect" placeholder="например, хочу чаще играть в вечерних турнирах…"></textarea>
        </div>

        <div class="group">
          <label for="partners">С кем комфортно играть? (ники через запятую, если есть)</label>
          <input class="input" id="partners" name="partners" placeholder="например, DeKo_Sun, PlayerX" />
        </div>

        <div class="group">
          <label for="conflicts">Есть нежелательные сочетания или конфликты?</label>
          <textarea id="conflicts" name="conflicts" placeholder="например, избегать пары с PlayerY"></textarea>
        </div>

        <div class="group">
          <label class="chip"><input type="checkbox" id="notify_ok" required /><span class="toggler"></span><span class="label-inline">Согласен получать теги и уведомления от бота</span></label>
          <label class="chip" style="margin-top:8px;"><input type="checkbox" id="rules_ok" required /><span class="toggler"></span><span class="label-inline">Подтверждаю честную игру и уважение к участникам клана</span></label>
        </div>

        <button class="submit" type="submit">ЗАРЕГИСТРИРОВАТЬСЯ</button>
      </form>
    </div>

    <!-- ===== Admin Dashboard ===== -->
    <div id="admin" class="card" style="display:none; padding:14px 14px 18px">
      <h2 style="margin:6px 0 14px; font-family:'Ruslan Display',serif; letter-spacing:.06em">Мини-дашборд</h2>

      <div class="dash-row">
        <!-- Фильтры -->
        <div class="filters">
          <div class="filter-group">
            <div class="fg-title">Дни</div>
            <div id="flt-days" class="pills"></div>
          </div>
          <div class="filter-group">
            <div class="fg-title">Время</div>
            <div id="flt-times" class="pills"></div>
          </div>
          <div class="filter-group">
            <div class="fg-title">Колоды</div>
            <div id="flt-decks" class="pills"></div>
          </div>

          <!-- Ровный тумблер МСК -->
          <div class="filter-group toggle-row">
            <div class="fg-title toggle-label">Показывать в МСК (UTC+3)</div>
            <label class="toggle-pill" id="mskBtn">
              <input id="mskToggle" type="checkbox" hidden checked />
              <span id="mskLabel">ВКЛ</span>
            </label>
          </div>

          <!-- Кнопки в центре, затем поиск -->
          <div class="actions">
            <button id="reset"  class="btn">Сбросить</button>
            <button id="reload" class="btn">Обновить</button>
          </div>
          <input class="input" id="search" placeholder="поиск по нику" style="margin-top:8px" />
        </div>

        <!-- Метрики + тепловая -->
        <div>
          <div class="dash-metrics" id="metrics">
            <div class="metric"><div class="k" id="m-total">0</div><div class="l">Всего игроков</div></div>
            <div class="metric"><div class="k" id="m-beg">0</div><div class="l">Новички</div></div>
            <div class="metric"><div class="k" id="m-mid">0</div><div class="l">Опытные</div></div>
            <div class="metric"><div class="k" id="m-vet">0</div><div class="l">Ветераны</div></div>
          </div>
          <div class="heat" id="heat" style="margin-top:10px"></div>
        </div>
      </div>

      <div id="grid" style="overflow:auto; max-height:60vh; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:6px"></div>
    </div>
  </div>

  <!-- 🔔 Phoenix toasts -->
  <div id="phoenix-toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
  (function(){
    if (window.__PHOENIX_BOOTED__) return;
    window.__PHOENIX_BOOTED__ = true;

    // ===== вспомогательные =====
    const DAYS  = ['Понедельник','Вторник','Среда','Четверг','Пятница','Суббота','Воскресенье'];
    const TIMES = ['07:00 – 10:00','10:00 – 13:00','13:00 – 16:00','16:00 – 19:00','19:00 – 23:00','23:00 – 06:00'];
    const DECKS = ['Вампир','Ктулху','Котэ','Стандарт','Орк','Упряжка','Гном','Звёздный'];

    // фон-видео
    (function(){
      const v=document.getElementById('bgvid'); if(!v) return;
      const pref=matchMedia('(prefers-reduced-motion: reduce)');
      const apply=e=>{ if(e.matches) v.pause(); else v.play().catch(()=>{}); };
      apply(pref); pref.addEventListener?.('change',apply);
    })();

    // анти-кеш для GIF локально
    (function(){
      const img=document.getElementById('egggif');
      if(!img) return;
      const base=img.getAttribute('src') || 'icons/egg.gif';
      if(!/\?/.test(base)) img.src = base + '?_=' + Date.now();
    })();

    // искры
    (function(){
      const cvs=document.getElementById('embers'); if(!cvs) return;
      const ctx=cvs.getContext('2d'); ctx.globalCompositeOperation='lighter';
      let W,H,arr=[]; const FX={rise:0.20, spin:0.010};
      function resize(){W=innerWidth; H=innerHeight; cvs.width=W; cvs.height=H; make();}
      function make(){const n=Math.min(260,Math.floor(W*H/6500));
        arr=Array.from({length:n},()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.5+.25,s:Math.random()*.6+.25,a:Math.random()*Math.PI*2}))
      }
      function draw(){
        ctx.clearRect(0,0,W,H);
        for(const p of arr){
          p.a+=FX.spin; const t=(Math.sin(p.a)+1)/2;
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r+t*.7,0,Math.PI*2);
          ctx.fillStyle=`rgba(255,${120+(t*90|0)},0,${.28+t*.25})`; ctx.fill();
          p.y-=(p.s)*FX.rise; if(p.y<-6){p.y=H+6;p.x=Math.random()*W;}
        }
        requestAnimationFrame(draw);
      }
      resize(); draw(); addEventListener('resize',resize);
    })();

    // пёрышки
    (function(){
      const box=document.querySelector('.feathers'); if(!box) return;
      const glyphs='~ ∿ 〰  ≈  ∼  ˜  ﹌  ﹋';
      for(let i=0;i<30;i++){
        const s=document.createElement('span');
        s.textContent=glyphs[Math.floor(Math.random()*glyphs.length)];
        s.style.left=(Math.random()*100)+'%';
        s.style.top=(Math.random()*100)+'%';
        s.style.animationDuration=(9+Math.random()*13)+'s';
        s.style.fontSize=(10+Math.random()*8)+'px';
        box.appendChild(s);
      }
    })();

    // чипы формы
    function renderChips(id, list, name){
      const box=document.getElementById(id); if(!box) return; box.innerHTML='';
      list.forEach(v=>{
        const lbl=document.createElement('label'); lbl.className='chip';
        if(id==='daysChips' && v==='Воскресенье') lbl.classList.add('sunday');
        lbl.innerHTML=`<input type="checkbox" name="${name}" value="${v}"><span class="toggler"></span><span class="label-inline">${v}</span>`;
        box.appendChild(lbl);
      });
    }
    renderChips('daysChips',DAYS,'days');
    renderChips('timesChips',TIMES,'times');

    /* ======= Toasts ======= */
    function showMessage(text, type='info', ms=10000){
      const host = document.getElementById('phoenix-toasts');
      if(!host) return alert(text);
      host.classList.toggle('stack', host.children.length > 0);
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.style.setProperty('--dur', `${ms}ms`);
      el.role = 'status';
      el.innerHTML = `<div>${text}</div>`;
      host.appendChild(el);
      setTimeout(()=>{ el.remove(); }, ms + 450);
    }
    const phoenix = {
      welcome(){ showMessage("🕊️ Пламя ФЕНИКСа приняло тебя! Добро пожаловать в семью, воин света!", "success"); },
      updated(){ showMessage("🔥 Твоя анкета возродилась из пепла — данные успешно обновлены!", "info"); },
      oops(){ showMessage("💀 Ошибка судьбы! Обратись к Хранителю огня @DeKo_Sun.", "error"); }
    };

    // ===== Supabase + сохранение =====
    let supabase;
    (async () => {
      const SUPABASE_URL = window.SUPABASE_URL;
      const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const qs = new URLSearchParams(location.search);
      const tgIdFromLink = qs.get("tg_id");
      const tgUserFromLink = qs.get("tg") || qs.get("username") || qs.get("tg_username");

      const tgField = document.getElementById("telegram");
      if (tgUserFromLink && tgField && !tgField.value)
        tgField.value = tgUserFromLink.replace(/^@/,"");

      const norm = s => (s||"").trim().replace(/^@/,"").toLowerCase();

      const form = document.getElementById("regForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const decks = [...form.querySelectorAll('input[name="decks"]:checked')].map(x=>x.value);
        const roles = [...form.querySelectorAll('input[name="roles"]:checked')].map(x=>x.value);
        const days  = [...form.querySelectorAll('input[name="days"]:checked')].map(x=>x.value);
        const times = [...form.querySelectorAll('input[name="times"]:checked')].map(x=>x.value);

        const telegramRaw = form.telegram.value;
        const telegram = telegramRaw ? telegramRaw.trim() : null;
        const telegram_id = /^\d+$/.test(tgIdFromLink||"") ? Number(tgIdFromLink) : null;

        const payload = {
          clan: "Феникс",
          nickname: form.nickname.value.trim(),
          telegram: telegram || null,
          telegram_id,
          birthdate: form.birthdate.value || null,
          country: form.country.value.trim() || null,
          city: form.city.value.trim() || null,
          days, times, decks, roles,
          experience: form.experience.value || null,
          expectations: form.expect?.value.trim() || null,
          partners: form.partners?.value.trim() || null,
          conflicts: form.conflicts?.value.trim() || null,
          play_other: document.getElementById("play_other")?.checked || false,
          clan_life:  document.getElementById("clan_life")?.checked  || false,
          user_agent: navigator.userAgent,
          updated_at: new Date().toISOString(),
        };

        // Вычисляем tz локально (не ломаем БД, если колонок нет)
        const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || null;
        const tzOffsetMin = getTzOffsetMinutesSafe(tzName, new Date());

        try {
          let playerId = null;
          let didUpdate = false;

          // найти профиль
          if (telegram_id) {
            const { data: byId, error: e1 } = await supabase
              .from("rg_players")
              .select("id")
              .eq("telegram_id", telegram_id)
              .maybeSingle();
            if (e1) throw e1;
            playerId = byId?.id || null;
          }
          if (!playerId && telegram) {
            const { data: byName, error: e2 } = await supabase
              .from("rg_players")
              .select("id")
              .eq("telegram_norm", norm(telegram))
              .maybeSingle();
            if (e2) throw e2;
            playerId = byName?.id || null;
          }

          // сохранить
          if (playerId) {
            const { error: updErr } = await supabase
              .from("rg_players")
              .update(payload)
              .eq("id", playerId);
            if (updErr) throw updErr;
            didUpdate = true;
          } else {
            const { data: ins, error: insErr } = await supabase
              .from("rg_players")
              .insert({ ...payload, created_at: new Date().toISOString() })
              .select("id")
              .maybeSingle();
            if (insErr && insErr.code === "23505") {
              let updQ = supabase.from("rg_players").update(payload);
              if (telegram_id) updQ = updQ.eq("telegram_id", telegram_id);
              else if (telegram) updQ = updQ.eq("telegram_norm", norm(telegram));
              const { error: fixErr } = await updQ;
              if (fixErr) throw fixErr;
              didUpdate = true;
            } else if (insErr) {
              throw insErr;
            } else {
              playerId = ins?.id || playerId;
            }
          }

          // записать tz (мягко, если колонок нет — игнор)
          if (playerId && tzName){
            try{
              await supabase.from("rg_players").update({
                tz_name: tzName,
                tz_offset_minutes: tzOffsetMin
              }).eq("id", playerId);
            }catch(_e){}
          }

          // согласия
          if (!playerId) throw new Error("Не удалось определить ID игрока после сохранения.");
          const { error: consErr } = await supabase.from("rg_consents").upsert(
            {
              player_id: playerId,
              notify_ok: document.getElementById("notify_ok").checked,
              rules_ok:  document.getElementById("rules_ok").checked,
            },
            { onConflict: "player_id" }
          );
          if (consErr) throw consErr;

          if (didUpdate) phoenix.updated(); else phoenix.welcome();

        } catch (err) {
          console.error("Ошибка Supabase:", err);
          phoenix.oops();
        }
      });
    })();

    // ===== Admin Dashboard logic (с МСК-режимом) =====
    (function(){
      const isAdmin = new URLSearchParams(location.search).get('admin')==='1';
      if(!isAdmin) return;
      document.getElementById('admin').style.display='block';

      const mskToggle = document.getElementById('mskToggle');
      const mskLabel  = document.getElementById('mskLabel');
      const mskBtn    = document.getElementById('mskBtn');

      function setMskUI(){
        mskLabel.textContent = mskToggle.checked ? 'ВКЛ' : 'ВЫКЛ';
        mskBtn.classList.toggle('active', mskToggle.checked);
      }
      setMskUI();
      mskToggle.addEventListener('change', ()=>{ setMskUI(); applyFilters(); });

      // Pills render
      function renderPills(containerId, list){
        const box = document.getElementById(containerId);
        box.innerHTML = '';
        list.forEach(v=>{
          const b=document.createElement('button');
          b.type='button'; b.className='pill'; b.textContent=v; b.dataset.value=v;
          b.addEventListener('click',()=>{ b.classList.toggle('active'); applyFilters(); });
          box.appendChild(b);
        });
      }
      renderPills('flt-days',  DAYS);
      renderPills('flt-times', TIMES);
      renderPills('flt-decks', DECKS);

      // State
      let allRows = [];
      let supaReadyInterval = setInterval(()=>{ if (window.supabase){ clearInterval(supaReadyInterval); init(); } }, 50);

      async function init(){
        await load(); // первичная загрузка
        document.getElementById('reload').addEventListener('click', load);
        document.getElementById('reset').addEventListener('click', ()=>{
          document.querySelectorAll('.pill.active').forEach(p=>p.classList.remove('active'));
          document.getElementById('search').value='';
          applyFilters();
        });
        document.getElementById('search').addEventListener('input', applyFilters);
      }

      async function load(){
        const { data, error } = await supabase
          .from('rg_players')
          .select('id,nickname,telegram,telegram_norm,days,times,decks,experience,created_at,updated_at,tz_name,tz_offset_minutes')
          .order('created_at',{ascending:false})
          .limit(1000);
        if (error){
          document.getElementById('grid').textContent = error.message;
          return;
        }
        allRows = Array.isArray(data) ? data : [];
        applyFilters();
      }

      function getActive(containerId){
        return [...document.querySelectorAll(`#${containerId} .pill.active`)].map(p=>p.dataset.value);
      }

      function passFilters(r){
        const q = (document.getElementById('search').value||'').trim().toLowerCase();
        if (q){
          const hit = (r.nickname||'').toLowerCase().includes(q); // поиск только по нику
          if (!hit) return false;
        }

        const days = (r.days||[]);
        const timesLocal = (r.times||[]);
        const timesView  = mskToggle.checked ? toMSKTimes(r, timesLocal) : timesLocal;

        const fd = getActive('flt-days');   if (fd.length && !days.some(d=>fd.includes(d))) return false;
        const ft = getActive('flt-times');  if (ft.length && !timesView.some(t=>ft.includes(t))) return false;
        const fk = getActive('flt-decks');  if (fk.length && !(r.decks||[]).some(dk=>fk.includes(dk))) return false;

        return true;
      }

      function applyFilters(){
        const rows = allRows.filter(passFilters);
        renderMetrics(rows);
        renderHeat(rows);
        renderTable(rows);
      }

      function renderMetrics(rows){
        const total = rows.length;
        const beg = rows.filter(r=>r.experience?.startsWith('Новичок')).length;
        const mid = rows.filter(r=>r.experience?.startsWith('Опытный')).length;
        const vet = rows.filter(r=>r.experience?.startsWith('Ветеран')).length;
        document.getElementById('m-total').textContent = total;
        document.getElementById('m-beg').textContent = beg;
        document.getElementById('m-mid').textContent = mid;
        document.getElementById('m-vet').textContent = vet;
      }

      function renderHeat(rows){
        const M = DAYS.map(()=>TIMES.map(()=>0));
        rows.forEach(r=>{
          const dlist = (r.days||[]);
          const tlist = mskToggle.checked ? toMSKTimes(r, (r.times||[])) : (r.times||[]);
          dlist.forEach(d=>{
            const di = DAYS.indexOf(d); if (di<0) return;
            tlist.forEach(t=>{
              const ti = TIMES.indexOf(t); if (ti<0) return;
              M[di][ti] += 1;
            });
          });
        });
        const max = Math.max(1, ...M.flat());
        const heat = document.getElementById('heat');
        const thead = `<thead><tr><th>День \\ Время ${mskToggle.checked ? '(МСК)' : '(лок.)'}</th>${TIMES.map(t=>`<th>${t}</th>`).join('')}</tr></thead>`;
        const tbody = `<tbody>${
          M.map((row,i)=>`<tr><th style="text-align:left; position:sticky; left:0; background:rgba(15,18,26,.95)">${DAYS[i]}</th>${
            row.map(v=>{
              const grade = Math.min(9, Math.round((v/max)*9));
              return `<td><span class="hcell heat-${grade}">${v}</span></td>`;
            }).join('')
          }</tr>`).join('')
        }</tbody>`;
        heat.innerHTML = `<table>${thead}${tbody}</table>`;
      }

      function renderTable(rows){
        const html = `
          <table style="width:100%; border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.10)">Ник</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.10)">Telegram</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.10)">Дни</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.10)">Время ${mskToggle.checked ? '(МСК)' : '(лок.)'}</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.10)">Колоды</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.10)">Опыт</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.10)">Создано</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r=>{
                const tlist = mskToggle.checked ? toMSKTimes(r, (r.times||[])) : (r.times||[]);
                return `
                <tr>
                  <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${r.nickname||''}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">@${r.telegram||''}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${(r.days||[]).join(', ')}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${tlist.join(', ')}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${(r.decks||[]).join(', ')}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${r.experience||''}</td>
                  <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,.08)">${r.created_at ? new Date(r.created_at).toLocaleString() : ''}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>`;
        document.getElementById('grid').innerHTML = html;
      }

      // ===== ВРЕМЕНА И ТАЙМЗОНЫ =====

      // парсер "HH:MM – HH:MM"
      function parseRange(label){
        const m = label.match(/^(\d{2}):(\d{2})\s*–\s*(\d{2}):(\d{2})$/);
        if(!m) return null;
        const s = (+m[1])*60 + (+m[2]);
        const e = (+m[3])*60 + (+m[4]);
        return { s, e };
      }

      const SLOT_LIST = TIMES.map(t=>({t, ...parseRange(t)}));

      // смещение интервала на delta минут
      function shiftInterval({s,e}, delta){
        const wrap = x => (x%1440+1440)%1440;
        const ns = wrap(s + delta);
        const ne = wrap(e + delta);
        return { s: ns, e: ne };
      }

      // пересечение [a,b) и [c,d) на 24ч окружности
      function overlapMinutes(a, b, c, d){
        function norm(x){return (x%1440+1440)%1440}
        a=norm(a); b=norm(b); c=norm(c); d=norm(d);
        function segOverlap(x1,x2,y1,y2){ return Math.max(0, Math.min(x2,y2) - Math.max(x1,y1)); }
        let tot = 0;
        const A = (b>=a) ? [[a,b]] : [[a,1440],[0,b]];
        const B = (d>=c) ? [[c,d]] : [[c,1440],[0,d]];
        for(const [x1,x2] of A){
          for(const [y1,y2] of B){
            tot += segOverlap(x1,x2,y1,y2);
          }
        }
        return tot;
      }

      // конвертация списка ярлыков игрока в ярлыки МСК
      function toMSKTimes(row, labels){
        if(!labels || !labels.length) return [];
        const tz = row.tz_name || null;
        const delta = getDeltaToMSK(tz, row.tz_offset_minutes);
        const resSet = new Set();
        for(const lab of labels){
          const pr = parseRange(lab); if(!pr) continue;
          const sh = shiftInterval(pr, delta);
          for(const slot of SLOT_LIST){
            const ov = overlapMinutes(sh.s, sh.e, slot.s, slot.e);
            const span = (slot.e >= slot.s) ? (slot.e-slot.s) : (1440 - slot.s + slot.e);
            if (ov >= 0.5 * span) resSet.add(slot.t);
          }
        }
        return Array.from(resSet);
      }

      // разница (в минутах), которую нужно ДОБАВИТЬ к локальному времени игрока, чтобы получить МСК
      function getDeltaToMSK(tzName, storedOffsetMin){
        const now = new Date();
        const mskOffset = getTzOffsetMinutesSafe('Europe/Moscow', now);
        if (tzName){
          const srcOffset = getTzOffsetMinutesSafe(tzName, now);
          return (mskOffset - srcOffset);
        }
        if (typeof storedOffsetMin === 'number' && Number.isFinite(storedOffsetMin)){
          return (mskOffset - storedOffsetMin);
        }
        return 0;
      }

      // безопасное получение смещения таймзоны в минутах
      function getTzOffsetMinutesSafe(tz, date){
        try{
          if(!tz) return 180; // дефолт МСК
          const fmt = new Intl.DateTimeFormat('en-US', {
            timeZone: tz,
            hourCycle:'h23',
            year:'numeric', month:'2-digit', day:'2-digit',
            hour:'2-digit', minute:'2-digit', second:'2-digit',
            timeZoneName: 'shortOffset'
          });
          const parts = fmt.formatToParts(date);
          const off = parts.find(p=>p.type==='timeZoneName')?.value || '';
          const m = off.match(/GMT([+-]\d{1,2})(?::?(\d{2}))?/i) || off.match(/UTC([+-]\d{1,2})(?::?(\d{2}))?/i);
          if (m){
            const h = parseInt(m[1],10);
            const mm = m[2] ? parseInt(m[2],10) : 0;
            return h*60 + Math.sign(h)*mm;
          }
          const fmt2 = new Intl.DateTimeFormat('en-US', { timeZone: tz, timeZoneName:'longOffset' });
          const parts2 = fmt2.formatToParts(date);
          const off2 = parts2.find(p=>p.type==='timeZoneName')?.value || '';
          const m2 = off2.match(/UTC([+-]\d{1,2}):(\d{2})/i);
          if(m2){
            const h = parseInt(m2[1],10), mm = parseInt(m2[2],10);
            return h*60 + Math.sign(h)*mm;
          }
        }catch(_e){}
        return 180;
      }
    })();
  })();
  </script>
</body>
</html>
